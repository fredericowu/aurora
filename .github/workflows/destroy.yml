name: Destroy Infrastructure

on:
  workflow_dispatch:
    inputs:
      confirm_destroy:
        description: 'Type "DESTROY" to confirm infrastructure destruction'
        required: true
        type: string
      force_unlock:
        description: 'Force unlock Terraform state lock if present'
        required: false
        default: 'false'
        type: boolean

jobs:
  destroy:
    name: Destroy Infrastructure
    runs-on: ubuntu-latest
    
    steps:
      - name: Validate Confirmation
        run: |
          if [ "${{ github.event.inputs.confirm_destroy }}" != "DESTROY" ]; then
            echo "‚ùå Destruction not confirmed. You must type 'DESTROY' to proceed."
            exit 1
          fi
          echo "‚ö†Ô∏è  WARNING: This will destroy ALL infrastructure!"
          echo "‚úÖ Confirmation received: ${{ github.event.inputs.confirm_destroy }}"
      
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION || 'us-east-1' }}
      
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: '1.6.0'
          terraform_wrapper: false
      
      - name: Setup Make
        run: |
          make --version
      
      - name: Create .env from secrets
        run: |
          cat > .env << EOF
          AWS_ACCESS_KEY_ID=${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY=${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION=${{ secrets.AWS_REGION || 'us-east-1' }}
          DB_PASSWORD=${{ secrets.DB_PASSWORD }}
          EOF
      
      - name: Initialize Terraform
        run: make init-terraform
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: ${{ secrets.AWS_REGION || 'us-east-1' }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
      
      - name: Create placeholder Lambda zip if missing
        run: |
          # For destroy operations, Terraform still validates the config
          # Create a minimal empty zip file if it doesn't exist
          if [ ! -f terraform/lambda_function.zip ]; then
            echo "Creating placeholder lambda_function.zip for destroy validation..."
            cd terraform
            # Create an empty zip file
            echo -n "" | zip -q lambda_function.zip - || python3 -c "import zipfile; zipfile.ZipFile('lambda_function.zip', 'w').close()" || touch lambda_function.zip
            echo "‚úì Placeholder created"
          fi
      
      - name: Handle State Lock
        if: github.event.inputs.force_unlock == 'true'
        run: |
          echo "‚ö†Ô∏è  Force unlock requested. Checking for state locks..."
          cd terraform
          # Attempt destroy first to see if there's a lock
          # If lock error occurs, the destroy step will handle it with better error message
          echo "Note: If a lock exists, you may need to manually unlock it."
          echo "To unlock manually, run: terraform force-unlock <LOCK_ID>"
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: ${{ secrets.AWS_REGION || 'us-east-1' }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
      
      - name: Terraform Destroy
        id: destroy
        run: |
          echo "üóëÔ∏è  Starting infrastructure destruction..."
          cd terraform
          # Capture output to check for lock errors
          if ! terraform destroy -auto-approve -var="db_password=${{ secrets.DB_PASSWORD }}" 2>&1 | tee /tmp/terraform-destroy.log; then
            EXIT_CODE=${PIPESTATUS[0]}
            echo ""
            echo "‚ö†Ô∏è  Destroy failed with exit code: $EXIT_CODE"
            # Check if error mentions state lock
            if grep -q "state lock\|Error acquiring the state lock" /tmp/terraform-destroy.log; then
              echo ""
              echo "‚ùå State lock detected!"
              echo "If you have a local Terraform process running, please stop it first."
              echo ""
              echo "To unlock manually:"
              echo "1. Extract the Lock ID from the error message above"
              echo "2. Run: terraform force-unlock <LOCK_ID>"
              echo ""
              echo "Or run this workflow again after stopping any local Terraform processes."
            fi
            exit $EXIT_CODE
          fi
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: ${{ secrets.AWS_REGION || 'us-east-1' }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
      
      - name: Destruction Complete
        if: success()
        run: |
          echo "‚úÖ Infrastructure destruction completed successfully"
          echo "All AWS resources have been removed."
      
      - name: Destruction Failed
        if: failure()
        run: |
          echo "‚ùå Infrastructure destruction failed"
          echo "Please check the logs above for details."
          echo ""
          echo "Common issues:"
          echo "- State lock: Another Terraform process may be running. Stop it or use force_unlock option."
          echo "- Missing resources: Some resources may have been manually deleted."
          echo "- Permissions: Ensure AWS credentials have necessary permissions."
          echo ""
          echo "Some resources may still exist. You may need to manually clean them up."

