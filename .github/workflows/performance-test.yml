name: Performance Test

on:
  push:
    branches:
      - main
    paths:
      - 'scripts/performance_test.py'
      - '.github/workflows/performance-test.yml'
  workflow_dispatch:
    inputs:
      iterations:
        description: 'Number of test iterations'
        required: false
        default: '10'
        type: string

jobs:
  performance-test:
    name: Run Performance Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION || 'us-east-1' }}
      
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: '1.6.0'
          terraform_wrapper: false
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'
      
      - name: Check Runner Location
        run: |
          echo "ðŸŒ Runner Location Information:"
          echo "Hostname: $(hostname)"
          echo "Public IP: $(curl -s https://api.ipify.org)"
          echo "Location: $(curl -s https://ipapi.co/$(curl -s https://api.ipify.org)/json/ | jq -r '.city + ", " + .region + ", " + .country_name')"
          echo ""
      
      - name: Get API Gateway URL
        id: get-api-url
        run: |
          cd terraform
          terraform init
          API_URL=$(terraform output -raw api_gateway_url 2>/dev/null || echo "")
          if [ -z "$API_URL" ]; then
            echo "Error: Could not get API Gateway URL"
            exit 1
          fi
          echo "API_BASE_URL=$API_URL" >> $GITHUB_ENV
          echo "api_url=$API_URL" >> $GITHUB_OUTPUT
          echo ""
          echo "ðŸ“¡ Network Latency Test:"
          API_HOST=$(echo $API_URL | sed -e 's|https\?://||' -e 's|/.*||')
          echo "Testing latency to: $API_HOST"
          echo "Ping test (3 attempts):"
          for i in {1..3}; do
            curl -o /dev/null -s -w "  Attempt $i: %{time_total}s (DNS: %{time_namelookup}s, Connect: %{time_connect}s, Transfer: %{time_starttransfer}s)\n" "https://$API_HOST"
          done
          echo ""
      
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r scripts/requirements.txt
      
      - name: Run Performance Tests
        env:
          NUM_ITERATIONS: ${{ github.event.inputs.iterations || '10' }}
        run: |
          echo "ðŸš€ Running Performance Tests"
          echo "API URL: $API_BASE_URL"
          echo "Iterations: $NUM_ITERATIONS"
          echo ""
          python scripts/performance_test.py
      
      - name: Display Summary
        if: always()
        run: |
          echo "================================================"
          echo "Performance Test Completed"
          echo "API Endpoint: ${{ steps.get-api-url.outputs.api_url }}"
          echo "================================================"

